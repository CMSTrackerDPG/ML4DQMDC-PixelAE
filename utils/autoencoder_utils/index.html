<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>autoencoder_utils - Documentation for the ML4DQM/DC code</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Documentation for the ML4DQM/DC code</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">omsapi <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../omsapi/">README</a>
</li>
                                    
<li >
    <a href="../../omsapi/get_oms_data/">get_oms_data</a>
</li>
                                    
<li >
    <a href="../../omsapi/omsapi/">omsapi</a>
</li>
                                    
<li >
    <a href="../../omsapi/urls/">urls</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">omsinterface <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../omsinterface/">README</a>
</li>
                                    
<li >
    <a href="../../omsinterface/cert/">cert</a>
</li>
                                    
<li >
    <a href="../../omsinterface/connectiontools/">connectiontools</a>
</li>
                                    
<li >
    <a href="../../omsinterface/get_oms_data/">get_oms_data</a>
</li>
                                    
<li >
    <a href="../../omsinterface/omstools/">omstools</a>
</li>
                                    
<li >
    <a href="../../omsinterface/urls/">urls</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">run <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../run/">README</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">src <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../src/DataLoader/">DataLoader</a>
</li>
                                    
<li >
    <a href="../../src/HistStruct/">HistStruct</a>
</li>
                                    
<li >
    <a href="../../src/PlotStyleParser/">PlotStyleParser</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">classifiers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../src/classifiers/AutoEncoder/">AutoEncoder</a>
</li>
            
<li >
    <a href="../../src/classifiers/HistogramClassifier/">HistogramClassifier</a>
</li>
            
<li >
    <a href="../../src/classifiers/MaxPullClassifier/">MaxPullClassifier</a>
</li>
            
<li >
    <a href="../../src/classifiers/NMFClassifier/">NMFClassifier</a>
</li>
            
<li >
    <a href="../../src/classifiers/PCAClassifier/">PCAClassifier</a>
</li>
            
<li >
    <a href="../../src/classifiers/TemplateBasedClassifier/">TemplateBasedClassifier</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">cloudfitters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../src/cloudfitters/CloudFitter/">CloudFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/ExponentialFitter/">ExponentialFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/GaussianKdeFitter/">GaussianKdeFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/HyperRectangleFitter/">HyperRectangleFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/IdentityFitter/">IdentityFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/LogNormalFitter/">LogNormalFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/PCAGaussianFitter/">PCAGaussianFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/PCAGaussianKdeFitter/">PCAGaussianKdeFitter</a>
</li>
            
<li >
    <a href="../../src/cloudfitters/SeminormalFitter/">SeminormalFitter</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">utils <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">README</a>
</li>
                                    
<li class="active">
    <a href="./">autoencoder_utils</a>
</li>
                                    
<li >
    <a href="../clustering_utils/">clustering_utils</a>
</li>
                                    
<li >
    <a href="../csv_utils/">csv_utils</a>
</li>
                                    
<li >
    <a href="../dataframe_utils/">dataframe_utils</a>
</li>
                                    
<li >
    <a href="../generate_data_2d_utils/">generate_data_2d_utils</a>
</li>
                                    
<li >
    <a href="../generate_data_utils/">generate_data_utils</a>
</li>
                                    
<li >
    <a href="../hist_utils/">hist_utils</a>
</li>
                                    
<li >
    <a href="../json_utils/">json_utils</a>
</li>
                                    
<li >
    <a href="../mask_utils/">mask_utils</a>
</li>
                                    
<li >
    <a href="../plot_utils/">plot_utils</a>
</li>
                                    
<li >
    <a href="../refruns_utils/">refruns_utils</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../clustering_utils/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#autoencoder-utils">autoencoder utils</a></li>
            <li><a href="#msetop10">mseTop10</a></li>
            <li><a href="#msetop10raw">mseTop10Raw</a></li>
            <li><a href="#msetopnraw">mseTopNRaw</a></li>
            <li><a href="#chisquared">chiSquared</a></li>
            <li><a href="#chisquaredtopnraw">chiSquaredTopNRaw</a></li>
            <li><a href="#calculate95roc">calculate_roc</a></li>
            <li><a href="#get95roc">get_roc</a></li>
            <li><a href="#get95roc95from95hists">get_roc_from_hists</a></li>
            <li><a href="#get95confusion95matrix">get_confusion_matrix</a></li>
            <li><a href="#get95confusion95matrix95from95hists">get_confusion_matrix_from_hists</a></li>
            <li><a href="#get95wp">get_wp</a></li>
            <li><a href="#get95wp95maxauc">get_wp_maxauc</a></li>
            <li><a href="#getautoencoder">getautoencoder</a></li>
            <li><a href="#train95simple95autoencoder">train_simple_autoencoder</a></li>
            <li><a href="#clip95scores">clip_scores</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="autoencoder-utils">autoencoder utils</h1>
<p><strong>Utilities related to the training and evaluation of autoencoder models with keras</strong></p>
<p>The functionality in this script includes:
- definition of loss functions (several flavours of MSE or chi-squared)
- calculating and plotting ROC curves and confusion matrices
- definition of very simple ready-to-use keras model architectures</p>
<hr />
<h3 id="msetop10">mseTop10</h3>
<p>full signature:  </p>
<pre><code class="text">def mseTop10(y_true, y_pred)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">MSE top 10 loss function for autoencoder training  
input arguments:  
- y_true and y_pred: two numpy arrays of equal shape,  
  typically a histogram and its autoencoder reconstruction.  
  if two-dimensional, the arrays are assumed to have shape (nhists,nbins)!  
output:  
- mean squared error between y_true and y_pred,  
  where only the 10 bins with largest squared error are taken into account.  
  if y_true and y_pred are 2D arrays, this function returns 1D array (mseTop10 for each histogram)  
</code></pre>

<h3 id="msetop10raw">mseTop10Raw</h3>
<p>full signature:  </p>
<pre><code class="text">def mseTop10Raw(y_true, y_pred)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">same as mseTop10 but without using tf or K  
the version including tf or K seemed to cause randomly dying kernels, no clear reason could be found,  
but it was solved using this loss function instead.  
verified that it gives exactly the same output as the function above on some random arrays.  
contrary to mseTop10, this function only works for arrays with 2D shapes (so shape (nhists,nbins)), not for (nbins,).  
</code></pre>

<h3 id="msetopnraw">mseTopNRaw</h3>
<p>full signature:  </p>
<pre><code class="text">def mseTopNRaw(y_true, y_pred, n=10)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">generalization of mseTop10Raw to any number of bins to take into account  
note: now generalized to also work for 2D histograms, i.e. arrays of shape (nhists,nybins,nxbins)!  
      hence this is the most general method and preferred above mseTop10 and mseTop10Raw, which are only kept for reference  
input arguments:  
- y_true, y_pred: numpy arrays between which to calculate the mean square difference, of shape (nhists,nbins) or (nhists,nybins,nxbins)  
- n: number of largest elements to keep for averaging  
output:  
numpy array of shape (nhists)  
</code></pre>

<h3 id="chisquared">chiSquared</h3>
<p>full signature:  </p>
<pre><code class="text">def chiSquared(y_true, y_pred)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">chi2 loss function for autoencoder training  
input arguments:  
- y_true and y_pred: two numpy arrays of equal shape,  
  typically a histogram and its autoencoder reconstruction.  
  if two-dimensional, the arrays are assumed to have shape (nhists,nbins)!  
output:  
- relative mean squared error between y_true and y_pred,  
  if y_true and y_pred are 2D arrays, this function returns 1D array (chiSquared for each histogram)  
</code></pre>

<h3 id="chisquaredtopnraw">chiSquaredTopNRaw</h3>
<p>full signature:  </p>
<pre><code class="text">def chiSquaredTopNRaw(y_true, y_pred, n=10)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">generalization of chiSquared to any number of bins to take into account  
note: should work for 2D histograms as well (i.e. arrays of shape (nhistograms,nybins,nxbins)),  
      but not yet tested!  
input arguments:  
- y_true, y_pred: numpy arrays between which to calculate the mean square difference, of shape (nhists,nbins) or (nhists,nybins,nxbins)  
- n: number of largest elements to keep for summing  
output:  
numpy array of shape (nhists)  
</code></pre>

<h3 id="calculate95roc">calculate_roc</h3>
<p>full signature:  </p>
<pre><code class="text">def calculate_roc(scores, labels, scoreax)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">calculate a roc curve  
input arguments:  
- scores is a 1D numpy array containing output scores of any algorithm  
- labels is a 1D numpy array (equally long as scores) containing labels  
  note that 1 for signal and 0 for background is assumed!  
  this convention is only used to define what scores belong to signal or background;  
  the scores itself can be anything (not limited to (0,1)),   
  as long as the target for signal is higher than the target for background  
- scoreax is an array of score thresholds for which to compute the signal and background efficiency,  
  assumed to be sorted in increasing order (i.e. from loose to tight)  
output:  
- tuple of two np arrays (signal efficiency and background efficiency)  
</code></pre>

<h3 id="get95roc">get_roc</h3>
<p>full signature:  </p>
<pre><code class="text">def get_roc(scores, labels, mode='lin', npoints=100, doprint=False,  doplot=True, doshow=True, returneffs=False )  
</code></pre>

<p>comments:  </p>
<pre><code class="text">make a ROC curve  
input arguments:  
- scores is a 1D numpy array containing output scores of any algorithm  
- labels is a 1D numpy array (equally long as scores) containing labels  
  note that 1 for signal and 0 for background is assumed!  
  this convention is only used to define what scores belong to signal or background;  
  the scores itself can be anything (not limited to (0,1)),   
  as long as the target for signal is higher than the target for background  
- mode: how to determine the points where to calculate signal and background efficiencies; options are:  
        - 'lin': np.linspace between min and max score  
        - 'geom': np. geomspace between min and max score  
        - 'full': one point per score instance  
- npoints: number of points where to calculate the signal and background efficiencies  
  (ignored if mode is 'full')  
- doprint: boolean whether to print score thresholds and corresponding signal and background efficiencies  
- doplot: boolean whether to make a plot  
- doshow: boolean whether to call plt.show  
- returneffs: boolean whether to return the signal and background efficiencies  
returns:  
- if returneffs is False, only the AUC value is returned  
- if returneffs is True, the return type is a tuple of the form (auc,sigeff,bckeff)  
</code></pre>

<h3 id="get95roc95from95hists">get_roc_from_hists</h3>
<p>full signature:  </p>
<pre><code class="text">def get_roc_from_hists(hists, labels, predicted_hists, mode='lin', npoints=100, doprint=False, doplot=True, plotmode='classic')  
</code></pre>

<p>comments:  </p>
<pre><code class="text">make a ROC curve without manually calculating the scores  
the output score is the mseTop10Raw between the histograms and their reconstruction  
- input arguments:  
- hists and predicted_hists are 2D numpy arrays of shape (nhistograms,nbins)  
- other arguments: see get_roc  
</code></pre>

<h3 id="get95confusion95matrix">get_confusion_matrix</h3>
<p>full signature:  </p>
<pre><code class="text">def get_confusion_matrix(scores, labels, wp='maxauc', plotwp=True)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">plot a confusion matrix  
input arguments:  
- scores and labels: defined in the same way as for get_roc  
- wp: the chosen working point   
      (i.e. any score above wp is flagged as signal, any below is flagged as background)  
      note: wp can be a integer or float, in which case that value will be used directly,  
            or it can be a string in which case it will be used as the 'method' argument in get_wp!  
- plotwp: only relevant if wp is a string (see above), in which case plotwp will be used as the 'doplot' argument in get_wp  
</code></pre>

<h3 id="get95confusion95matrix95from95hists">get_confusion_matrix_from_hists</h3>
<p>full signature:  </p>
<pre><code class="text">def get_confusion_matrix_from_hists(hists, labels, predicted_hists, msewp=None)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">plot a confusion matrix without manually calculating the scores  
the output score is the mse between the histograms and their reconstruction  
</code></pre>

<h3 id="get95wp">get_wp</h3>
<p>full signature:  </p>
<pre><code class="text">def get_wp(scores, labels, method='maxauc', doplot=False)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">automatically calculate a suitable working point  
input arguments:  
- scores, labels: equally long 1d numpy arrays of predictions and true labels respectively  
                  note: in all methods, the labels are assumed to be 0 (for background) or 1 (for signal)!  
- method: method to calculate the working point  
          currently supported: 'maxauc'  
- doplot: make a plot (if a plotting method exists for the chosen method)  
</code></pre>

<h3 id="get95wp95maxauc">get_wp_maxauc</h3>
<p>full signature:  </p>
<pre><code class="text">def get_wp_maxauc(scores, labels, doplot=False)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">calculate the working point corresponding to maximum pseudo-AUC  
(i.e. maximize the rectangular area enclosed by the working point)  
</code></pre>

<h3 id="getautoencoder">getautoencoder</h3>
<p>full signature:  </p>
<pre><code class="text">def getautoencoder(input_size,arch,act=[],opt='adam',loss=mseTop10)  
</code></pre>

<p>comments:  </p>
<pre><code class="text">get a trainable autoencoder model  
input args:  
- input_size: size of vector that autoencoder will operate on  
- arch: list of number of nodes per hidden layer (excluding input and output layer)  
- act: list of activations per layer (default: tanh)  
- opt: optimizer to use (default: adam)  
- loss: loss function to use (defualt: mseTop10)  
</code></pre>

<h3 id="train95simple95autoencoder">train_simple_autoencoder</h3>
<p>full signature:  </p>
<pre><code class="text">def train_simple_autoencoder(hists, nepochs=-1, modelname='',  batch_size=500, shuffle=False,  verbose=1, validation_split=0.1, returnhistory=False )  
</code></pre>

<p>comments:  </p>
<pre><code class="text">create and train a very simple keras model  
the model consists of one hidden layer (with half as many units as there are input bins),   
tanh activation, adam optimizer and mseTop10 loss.  
input args:   
- hists is a 2D numpy array of shape (nhistograms, nbins)  
- nepochs is the number of epochs to use (has a default value if left unspecified)  
- modelname is a file name to save the model in (default: model is not saved to a file)  
- batch_size, shuffle, verbose, validation_split: passed to keras .fit method  
- returnhistory: boolean whether to return the training history (e.g. for making plots)  
returns  
- if returnhistory is False, only the trained keras model is returned  
- if returnhistory is True, the return type is a tuple of the form (model, history)  
</code></pre>

<h3 id="clip95scores">clip_scores</h3>
<p>full signature:  </p>
<pre><code class="text">def clip_scores( scores )  
</code></pre>

<p>comments:  </p>
<pre><code class="text">clip +-inf values in scores  
+inf values in scores will be replaced by the maximum value (exclucing +inf) plus one  
-inf values in scores will be replaced by the minimim value (exclucing -inf) minus one  
input arguments:  
- scores: 1D numpy array  
returns  
- array with same length as scores with elements replaced as explained above  
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
